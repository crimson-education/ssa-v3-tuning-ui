<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced College Admission Predictor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: grid;
            grid-template-columns: 400px 1fr 350px;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
            height: 95vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .title {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }

        .plot-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            position: relative;
        }

        .info-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            font-size: 13px;
            line-height: 1.4;
        }

        .button-panel {
            grid-column: 1 / -1;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .slider-group {
            margin-bottom: 20px;
        }

        .slider-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .slider-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .slider-track-wrap {
            position: relative;
            flex: 1 1 auto;
            min-width: 0;
        }

        input.param-slider[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e6e6e6;
            outline: none;
            -webkit-appearance: none;
        }

        input.param-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative; /* keep the thumb visually above the marker */
            z-index: 3;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .slider-value {
            position: absolute;
            right: 0;
            top: -25px;
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .control-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .control-button.export { background: linear-gradient(45deg, #007bff, #6610f2); }
        .control-button.load { background: linear-gradient(45deg, #ffc107, #fd7e14); }
        .control-button.save { background: linear-gradient(45deg, #dc3545, #e83e8c); }

        .info-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .info-section h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .info-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .info-section li {
            margin-bottom: 5px;
        }

        .parameter-display {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }

        #plotDiv {
            width: 100%;
            height: 100%;
            min-height: 500px;
        }

        .hidden-file-input {
            display: none;
        }

        .navigation-hint {
            position: absolute;
            top: 10px;
            left: 10px; /* instead of right */
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
        }

        .default-marker {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%); /* center vertically, center X at left% */
            width: 2px;               /* thin vertical line */
            height: 20px;             /* extend above/below track a little */
            background: rgba(0,0,0,0.12);  /* faded */
            border-radius: 1px;
            pointer-events: none;     /* don't block dragging */
            z-index: 1;               /* behind the thumb */
        }

        .slider-value-input {
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: #fff;
            font-size: 13px;
            padding: 6px 8px;
            width: 70px;
            color: #495057;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .slider-value-input:focus {
            outline: none;
            border-color: #8e44ad;
            box-shadow: 0 0 0 6px rgba(142,68,173,0.06);
            background: #fff;
        }

        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 350px 1fr 300px;
            }
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto auto;
            }
            
            .controls-panel, .info-panel {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">Interactive Smooth Sigmoid College Admission Predictor with Full Navigation</div>
        
        <div class="controls-panel">
            <h3 style="margin-top: 0; text-align: center; color: #2c3e50;">Parameter Controls</h3>
            
            <div class="slider-group">
                <label for="academic-weight">Academic Weight</label>
                <div class="slider-container">
                    <input type="range" id="academic-weight" min="0.1" max="0.9" step="0.01" value="0.7">
                    <div class="slider-value" id="academic-weight-val">0.70</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="midpoint-base">Midpoint Base Rank</label>
                <div class="slider-container">
                    <input type="range" id="midpoint-base" min="5" max="75" step="0.1" value="25">
                    <div class="slider-value" id="midpoint-base-val">25.0</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="midpoint-sensitivity">Midpoint Sensitivity</label>
                <div class="slider-container">
                    <input type="range" id="midpoint-sensitivity" min="0.5" max="15" step="0.1" value="3.5">
                    <div class="slider-value" id="midpoint-sensitivity-val">3.5</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="midpoint-bias">Midpoint Sensitivity Bias</label>
                <div class="slider-container">
                    <input type="range" id="midpoint-bias" min="-2" max="2" step="0.01" value="0">
                    <div class="slider-value" id="midpoint-bias-val">0.00</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="left-steepness">Left Steepness (Elite)</label>
                <div class="slider-container">
                    <input type="range" id="left-steepness" min="0.5" max="25" step="0.1" value="5">
                    <div class="slider-value" id="left-steepness-val">5.0</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="right-steepness">Right Steepness (Safety)</label>
                <div class="slider-container">
                    <input type="range" id="right-steepness" min="0.5" max="25" step="0.1" value="5">
                    <div class="slider-value" id="right-steepness-val">5.0</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="academic-impact">Academic Steepness Impact</label>
                <div class="slider-container">
                    <input type="range" id="academic-impact" min="0" max="5" step="0.1" value="1">
                    <div class="slider-value" id="academic-impact-val">1.0</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="extra-impact">Extracurricular Steepness Impact</label>
                <div class="slider-container">
                    <input type="range" id="extra-impact" min="0" max="5" step="0.1" value="1">
                    <div class="slider-value" id="extra-impact-val">1.0</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="asymmetry">Asymmetry Factor</label>
                <div class="slider-container">
                    <input type="range" id="asymmetry" min="0" max="1" step="0.01" value="0.3">
                    <div class="slider-value" id="asymmetry-val">0.30</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="elite-threshold">Elite Flatten Threshold</label>
                <div class="slider-container">
                    <input type="range" id="elite-threshold" min="1" max="6" step="0.1" value="5">
                    <div class="slider-value" id="elite-threshold-val">5.0</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="elite-aggression">Elite Flatten Aggression</label>
                <div class="slider-container">
                    <input type="range" id="elite-aggression" min="0.1" max="10" step="0.1" value="2">
                    <div class="slider-value" id="elite-aggression-val">2.0</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="weak-threshold">Weak Steepen Threshold</label>
                <div class="slider-container">
                    <input type="range" id="weak-threshold" min="1" max="6" step="0.1" value="3">
                    <div class="slider-value" id="weak-threshold-val">3.0</div>
                </div>
            </div>

            <div class="slider-group">
                <label for="weak-aggression">Weak Steepen Aggression</label>
                <div class="slider-container">
                    <input type="range" id="weak-aggression" min="0.1" max="10" step="0.1" value="2">
                    <div class="slider-value" id="weak-aggression-val">2.0</div>
                </div>
            </div>

            <div class="parameter-display" id="current-params">
                Current Parameters Loading...
            </div>
        </div>

        <div class="plot-container">
            <div class="navigation-hint">🔍 Drag to pan • Scroll to zoom • Double-click to reset</div>
            <div id="plotDiv"></div>
        </div>

        <div class="info-panel">
            <div class="info-section">
                <h3>🎯 Parameter Guide</h3>
                <ul>
                    <li><strong>Academic Weight:</strong> Relative importance of academic vs extracurricular scores</li>
                    <li><strong>Midpoint Base:</strong> Where average student (3.5,3.5) has 50% chance</li>
                    <li><strong>Midpoint Sensitivity:</strong> How much scores shift the 50% probability point</li>
                    <li><strong>Midpoint Bias:</strong> Quadratic scaling - positive penalizes worse students more</li>
                    <li><strong>Steepness:</strong> Controls curve shape for elite/safety schools</li>
                    <li><strong>Asymmetry:</strong> Penalty for academic vs extracurricular weakness</li>
                </ul>
            </div>

            <div class="info-section">
                <h3>🔧 Elite/Weak Controls</h3>
                <ul>
                    <li><strong>Elite Flatten:</strong> Makes top students have more consistent high probabilities</li>
                    <li><strong>Weak Steepen:</strong> Harsher penalties for weakest students</li>
                    <li><strong>Threshold:</strong> Combined score where effect begins</li>
                    <li><strong>Aggression:</strong> How strongly the effect applies</li>
                </ul>
            </div>

            <div class="info-section">
                <h3>📊 Student Profiles</h3>
                <ul>
                    <li><strong>Solid lines:</strong> Balanced students (A=E)</li>
                    <li><strong>Dashed lines:</strong> Academic-heavy (A>E)</li>
                    <li><strong>Dotted lines:</strong> Extracurricular-heavy (E>A)</li>
                    <li><strong>Dots:</strong> 50% probability points</li>
                </ul>
            </div>

            <div class="info-section">
                <h3>🏫 University Tiers</h3>
                <ul>
                    <li>Rank 1: Harvard/Stanford</li>
                    <li>Rank 5: Columbia/UChicago</li>
                    <li>Rank 10: Northwestern/Duke</li>
                    <li>Rank 15: Vanderbilt/Rice</li>
                    <li>Rank 20: Emory/Georgetown</li>
                    <li>Rank 30: NYU/Boston College</li>
                    <li>Rank 40: Case Western/Tulane</li>
                    <li>Rank 50: Miami/BU</li>
                </ul>
            </div>

            <div class="info-section">
                <h3>🚀 Navigation</h3>
                <ul>
                    <li><strong>Drag:</strong> Pan around the plot</li>
                    <li><strong>Scroll:</strong> Zoom in/out</li>
                    <li><strong>Double-click:</strong> Reset view</li>
                    <li><strong>Select:</strong> Box zoom mode</li>
                </ul>
            </div>
        </div>

        <div class="button-panel">
            <button class="control-button export" onclick="exportParameters()">📤 Export Parameters</button>
            <button class="control-button load" onclick="document.getElementById('load-file').click()">📥 Load Parameters</button>
            <button class="control-button" onclick="resetToDefaults()" style="background: linear-gradient(45deg, #6c757d, #495057);">🔄 Reset Defaults</button>
        </div>
    </div>

    <input type="file" id="load-file" class="hidden-file-input" accept=".json" onchange="loadParameters(event)">

    <script>
        // Global parameters object
        const params = {
            academicWeight: 0.7,
            midpointBaseRank: 25,
            midpointSensitivity: 3.5,
            midpointSensitivityBias: 0.0,
            leftSteepness: 5.0,
            rightSteepness: 5.0,
            academicSteepnessImpact: 1.0,
            extracurricularSteepnessImpact: 1.0,
            asymmetryFactor: 0.3,
            eliteFlattenThreshold: 5.0,
            eliteFlattenAggression: 2.0,
            weakFlattenThreshold: 3.0,
            weakFlattenAggression: 2.0
        };

        const defaultParams = {
            academicWeight: 0.7,
            midpointBaseRank: 25,
            midpointSensitivity: 3.5,
            midpointSensitivityBias: 0.0,
            leftSteepness: 5.0,
            rightSteepness: 5.0,
            academicSteepnessImpact: 1.0,
            extracurricularSteepnessImpact: 1.0,
            asymmetryFactor: 0.3,
            eliteFlattenThreshold: 5.0,
            eliteFlattenAggression: 2.0,
            weakFlattenThreshold: 3.0,
            weakFlattenAggression: 2.0
        };

        const paramConfig = {
            academicWeight: { min: 0.1, max: 0.9, step: 0.01 },
            midpointBaseRank: { min: 5, max: 75, step: 0.1 },
            midpointSensitivity: { min: 0.5, max: 15, step: 0.1 },
            midpointSensitivityBias: { min: -2, max: 2, step: 0.01 },
            leftSteepness: { min: 0.5, max: 25, step: 0.1 },
            rightSteepness: { min: 0.5, max: 25, step: 0.1 },
            academicSteepnessImpact: { min: 0, max: 5, step: 0.1 },
            extracurricularSteepnessImpact: { min: 0, max: 5, step: 0.1 },
            asymmetryFactor: { min: 0, max: 1, step: 0.01 },
            eliteFlattenThreshold: { min: 1, max: 6, step: 0.1 },
            eliteFlattenAggression: { min: 0.1, max: 10, step: 0.1 },
            weakFlattenThreshold: { min: 1, max: 6, step: 0.1 },
            weakFlattenAggression: { min: 0.1, max: 10, step: 0.1 }
        };


        // University tiers for vertical lines
        const universityTiers = {
            'Harvard/Stanford': 1,
            'Columbia/UChicago': 5,
            'Northwestern/Duke': 10,
            'Vanderbilt/Rice': 15,
            'Emory/Georgetown': 20,
            'NYU/Boston College': 30,
            'Case Western/Tulane': 40,
            'Miami/BU': 50
        };

        // Student profiles for display
        const studentProfiles = [
            [6, 6, 'Perfect (6,6)', 'solid'],
            [5, 5, 'Strong (5,5)', 'solid'],
            [4, 4, 'Good (4,4)', 'solid'],
            [3, 3, 'Average (3,3)', 'solid'],
            [6, 3, 'Academic Heavy (6,3)', 'dash'],
            [3, 6, 'Extracurricular Heavy (3,6)', 'dot'],
            [5, 2, 'Very Academic (5,2)', 'dash'],
            [2, 5, 'Very Extracurricular (2,5)', 'dot']
        ];

        // Colors for different profiles
        const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#17becf', '#e377c2'];

        // Calculate midpoint rank with bias
        function calculateMidpointRank(academicScore, extracurricularScore) {
            const combinedScore = params.academicWeight * academicScore + 
                                (1 - params.academicWeight) * extracurricularScore;
            
            const scoreDeviation = combinedScore - 3.5;
            let biasMultiplier = 1.0;
            
            if (params.midpointSensitivityBias !== 0) {
                if (params.midpointSensitivityBias > 0) {
                    if (scoreDeviation < 0) {
                        biasMultiplier = 1 + Math.abs(scoreDeviation) ** 2 * params.midpointSensitivityBias;
                    }
                } else {
                    if (scoreDeviation > 0) {
                        biasMultiplier = 1 + scoreDeviation ** 2 * Math.abs(params.midpointSensitivityBias);
                    }
                }
            }
            
            const effectiveSensitivity = params.midpointSensitivity * biasMultiplier;
            const midpointRank = params.midpointBaseRank - scoreDeviation * effectiveSensitivity;
            return midpointRank
        }

        // Calculate steepness parameters
        function calculateSteepnessParameters(academicScore, extracurricularScore) {
            const combinedScore = params.academicWeight * academicScore + 
                                (1 - params.academicWeight) * extracurricularScore;
            
            let leftSteep = params.leftSteepness;
            let rightSteep = params.rightSteepness;
            
            // Adjust based on individual scores
            leftSteep *= (1 - (academicScore - 1) * 0.1 * params.academicSteepnessImpact);
            rightSteep *= (1 + (extracurricularScore - 1) * 0.1 * params.extracurricularSteepnessImpact);
            
            // Elite student flattening
            if (combinedScore > params.eliteFlattenThreshold) {
                const eliteExcess = combinedScore - params.eliteFlattenThreshold;
                const eliteFlattenFactor = 1 - (eliteExcess * 0.2 * params.eliteFlattenAggression);
                leftSteep *= Math.max(0.1, eliteFlattenFactor);
            }
            
            // Weak student steepening
            if (combinedScore < params.weakFlattenThreshold) {
                const weakDeficit = params.weakFlattenThreshold - combinedScore;
                const weakFlattenFactor = 1 - (weakDeficit * 0.3 * params.weakFlattenAggression);
                rightSteep *= weakFlattenFactor;
            }
            
            // Apply asymmetry penalty
            const scoreDiff = academicScore - extracurricularScore;
            if (scoreDiff < 0) {
                leftSteep *= (1 + Math.abs(scoreDiff) * params.asymmetryFactor);
                rightSteep *= (1 - Math.abs(scoreDiff) * params.asymmetryFactor * 0.2);
            } else if (scoreDiff > 0) {
                leftSteep *= (1 + Math.abs(scoreDiff) * params.asymmetryFactor * 0.5);
                rightSteep *= (1 + Math.abs(scoreDiff) * params.asymmetryFactor * 0.3);
            }
            
            return [Math.max(0.1, leftSteep), Math.max(0.1, rightSteep)];
        }

        // Smooth asymmetric sigmoid
        function smoothAsymmetricSigmoid(universityRank, academicScore, extracurricularScore) {
            const midpointRank = calculateMidpointRank(academicScore, extracurricularScore);
            const [leftSteepness, rightSteepness] = calculateSteepnessParameters(academicScore, extracurricularScore);

            // Normalize difference relative to scale of ranks (e.g., top 50 schools)
            const rankScale = 50; // this can be adjusted or tied to your x-axis span
            const diff = (universityRank - midpointRank) / rankScale;

            // Apply asymmetric steepness
            let sigmoidInput;
            if (diff <= 0) {
                sigmoidInput = leftSteepness * diff;
            } else {
                sigmoidInput = rightSteepness * diff;
            }

            // Smooth sigmoid curve
            const probability = 100 / (1 + Math.exp(-sigmoidInput));

            return Math.max(0.1, Math.min(99.9, probability));
        }

        function toLabel(key) {
            // convert camelCase to Title Case for nicer labels (optional)
            return key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
        }

        function buildSliders() {
            const panel = document.querySelector('.controls-panel');
            panel.innerHTML = '<h3 style="margin-top: 0; text-align: center; color: #2c3e50;">Parameter Controls</h3>';

            Object.entries(paramConfig).forEach(([key, cfg]) => {
                const defaultValue = defaultParams[key] ?? params[key];

                const group = document.createElement('div');
                group.className = 'slider-group';

                // Structure:
                //  label
                //  .slider-container
                //    .slider-track-wrap  <-- holds range + default-marker (left% measured vs this wrapper)
                //    <input type="number">  <-- numeric input sits to the right (no overlap)
                group.innerHTML = `
                    <label for="${key}" style="display:block; margin-bottom:6px; font-weight:600; color:#495057;">${toLabel(key)}</label>
                    <div class="slider-container">
                        <div class="slider-track-wrap">
                            <input type="range" id="${key}" class="param-slider"
                                min="${cfg.min}" max="${cfg.max}" step="${cfg.step}" value="${params[key]}">
                            <div class="default-marker" id="${key}-marker" aria-hidden="true"></div>
                        </div>
                        <input type="number" id="${key}-val" class="slider-value-input"
                            step="${cfg.step}" value="${params[key]}">
                    </div>
                `;
                panel.appendChild(group);

                const slider = group.querySelector(`#${key}`);
                const valueInput = group.querySelector(`#${key}-val`);
                const marker = group.querySelector(`#${key}-marker`);
                const trackWrap = group.querySelector('.slider-track-wrap');

                // position marker as percentage of the track-wrap width (aligns with track)
                const percent = ((defaultValue - cfg.min) / (cfg.max - cfg.min)) * 100;
                marker.style.left = `${percent}%`;

                // format helper
                const fmt = cfg.step < 1 ? 2 : 1;
                valueInput.value = Number(params[key]).toFixed(fmt);

                // sync slider → input
                slider.addEventListener('input', e => {
                    const val = parseFloat(e.target.value);
                    params[key] = val;
                    valueInput.value = val.toFixed(fmt);
                    updateParameterDisplay();
                    updatePlot();
                });

                // sync input → slider
                valueInput.addEventListener('change', e => {
                    let val = parseFloat(e.target.value);
                    if (isNaN(val)) return;
                    val = Math.max(cfg.min, Math.min(cfg.max, val));
                    params[key] = val;
                    slider.value = val;
                    valueInput.value = val.toFixed(fmt);
                    updateParameterDisplay();
                    updatePlot();
                });
            });

            // keep the parameter display element
            if (!document.getElementById('current-params')) {
                const pd = document.createElement('div');
                pd.className = 'parameter-display';
                pd.id = 'current-params';
                pd.textContent = 'Current Parameters Loading...';
                panel.appendChild(pd);
            }
            updateParameterDisplay();
        }

        // Update plot
        function updatePlot() {
            const ranks = Array.from({ length: 500 }, (_, i) => 1 + i);

            const traces = [];
            studentProfiles.forEach(([academic, extracurricular, label, lineStyle]) => {
                const probabilities = ranks.map(rank =>
                    smoothAsymmetricSigmoid(rank, academic, extracurricular)
                );

                traces.push({
                    x: ranks,
                    y: probabilities,
                    mode: 'lines',
                    name: label,
                    line: { width: 2, dash: lineStyle }
                });
            });

            const plotDiv = document.getElementById('plotDiv');
            let currentLayout = {};
            if (plotDiv.layout) {
                currentLayout = {
                    'xaxis.range': plotDiv.layout.xaxis.range
                };
            }

            const layout = {
                title: 'Admission Probability Curves',
                xaxis: {
                    title: 'University Rank (1 = Harvard, 50 = Safety)',
                    range: [1, 50],              // default: top 50
                    fixedrange: false            // allow zooming
                },
                yaxis: {
                    title: 'Admission Probability (%)',
                    range: [0, 100],
                    fixedrange: true             // lock y-axis (no zoom/pan)
                },
                legend: {
                    orientation: 'h',
                    y: -0.3,
                    x: 0.5,
                    xanchor: 'center'
                },
                margin: { b: 100, t: 50, l: 70, r: 30 },
                dragmode: 'pan'                  // only pan horizontally
            };

            Plotly.react('plotDiv', traces, layout, { scrollZoom: true }).then(() => {
                if (currentLayout['xaxis.range']) {
                    Plotly.relayout('plotDiv', currentLayout);
                }
            });
        }

        // Update parameter display
        function updateParameterDisplay() {
            const display = document.getElementById('current-params');
            display.innerHTML = `
                Academic Weight: ${params.academicWeight.toFixed(2)} | Extra Weight: ${(1-params.academicWeight).toFixed(2)}<br>
                Midpoint Base: ${params.midpointBaseRank.toFixed(1)} | Sensitivity: ${params.midpointSensitivity.toFixed(1)} | Bias: ${params.midpointSensitivityBias.toFixed(2)}<br>
                Left Steepness: ${params.leftSteepness.toFixed(1)} | Right Steepness: ${params.rightSteepness.toFixed(1)}<br>
                Asymmetry: ${params.asymmetryFactor.toFixed(2)} | Elite: ${params.eliteFlattenThreshold.toFixed(1)}/${params.eliteFlattenAggression.toFixed(1)} | Weak: ${params.weakFlattenThreshold.toFixed(1)}/${params.weakFlattenAggression.toFixed(1)}
            `;
        }

        // Export parameters
        function exportParameters() {
            const dataStr = JSON.stringify(params, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'admission_predictor_params_' + new Date().toISOString().slice(0,10) + '.json';
            link.click();
            
            alert('Parameters exported successfully!');
        }

        // Map parameter names -> slider IDs
        const paramToSliderId = {
            academicWeight: 'academic-weight',
            midpointBaseRank: 'midpoint-base',
            midpointSensitivity: 'midpoint-sensitivity',
            midpointSensitivityBias: 'midpoint-bias',
            leftSteepness: 'left-steepness',
            rightSteepness: 'right-steepness',
            academicSteepnessImpact: 'academic-impact',
            extracurricularSteepnessImpact: 'extra-impact',
            asymmetryFactor: 'asymmetry',
            eliteFlattenThreshold: 'elite-threshold',
            eliteFlattenAggression: 'elite-aggression',
            weakFlattenThreshold: 'weak-threshold',
            weakFlattenAggression: 'weak-aggression'
        };

        // Reusable function to apply params to sliders + UI
        function applyParams(newParams) {
            // Merge newParams into live params object
            Object.assign(params, newParams);

            // For each parameter in paramConfig try to find the slider by:
            // 1) exact param key id (camelCase) — what buildSliders() creates
            // 2) fallback to kebab-case id (legacy)
            Object.keys(paramConfig).forEach(paramName => {
                const primaryId = paramName;
                const fallbackId = toKebab(paramName);
                let slider = document.getElementById(primaryId);
                let idUsed = primaryId;

                if (!slider) {
                    slider = document.getElementById(fallbackId);
                    idUsed = fallbackId;
                }

                const valueDisplay = document.getElementById(idUsed + '-val');

                if (slider) {
                    // Set slider.value as string (DOM expects string)
                    slider.value = String(params[paramName]);

                    // Update value display text with appropriate formatting
                    if (valueDisplay) {
                        if (['academicWeight', 'midpointSensitivityBias', 'asymmetryFactor'].includes(paramName)) {
                            valueDisplay.textContent = Number(params[paramName]).toFixed(2);
                        } else {
                            valueDisplay.textContent = Number(params[paramName]).toFixed(1);
                        }
                    }

                    // Dispatch a user-like InputEvent so attached listeners run reliably
                    // Some browsers require InputEvent for range change listeners to behave identically
                    try {
                        const ie = new InputEvent('input', { bubbles: true, cancelable: true });
                        slider.dispatchEvent(ie);
                    } catch (err) {
                        // Fallback if InputEvent constructor isn't available
                        slider.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                } else {
                    // No matching slider found — skip (this makes it tolerant to new params
                    // that don't have a UI control yet)
                    // console.debug(`No slider found for ${paramName} (tried ${primaryId} and ${fallbackId})`);
                }
            });

            // Update parameter display and re-render plot after changes
            updateParameterDisplay();
            updatePlot();
        }


        // Reset to defaults
        function resetToDefaults() {
            if (!confirm('Reset all parameters to default values?')) return;

            applyParams(defaultParams);
        }

        // Load parameters from file
        function loadParameters(event) {
            const file = event.target.files ? event.target.files[0] : null;
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedParams = JSON.parse(e.target.result);

                    // Apply loaded params
                    applyParams(loadedParams);

                    // Clear file input so the same file can be loaded again later
                    const fileInput = document.getElementById('load-file');
                    if (fileInput) fileInput.value = '';

                    alert('Parameters loaded successfully!');
                } catch (error) {
                    alert('Error loading parameters: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function toKebab(s) {
            return s.replace(/([A-Z])/g, '-$1').toLowerCase();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            buildSliders();
            updatePlot();
            
            console.log('🎓 College Admission Predictor Loaded!');
            console.log('📊 Features:');
            console.log('   • Full zoom/pan navigation on plot');
            console.log('   • Real-time parameter adjustment');
            console.log('   • Export/import parameter configurations');
            console.log('   • Save standalone prediction functions');
            console.log('   • Responsive design for all screen sizes');
        });
    </script>
</body>
</html>